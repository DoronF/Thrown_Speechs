{
  "hash": "684eeb10c94086ce459993f4428038d2",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"LLM Interpretation of Topic Models\"\nauthor: \"Doron Feingold\"\ndate: \"today\"\nformat: \n  html:\n    toc: true\n    toc-location: right\n    self-contained: true\n    theme: cosmo\n    code-overflow: wrap\n---\n\n## Overview\nThis document uses a Large Language Model (LLM) to interpret the topics generated by our LDA models in the previous step. The 'topics' generated by the models are collections of statistically related words. While these may be meaningful to a subject-matter expert, manual interpretation is a laborious process that can lead to inevitable subjectivity. We therefore chose to use an LLM to automate this step, prioritizing speed and reproducibility.\n\nFor this task, we selected Anthropic's Claude model, which has a reputation for nuanced cultural and historical interpretation. We'll use its API to interpret the topics from each of our k models, providing it with the highest-probability words (ranked by their beta values) for each topic.\n\n## Setup\n\nFirst, we load the necessary libraries and data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Seed\nset.seed(1867)\n\n# Load libraries\nlibrary(dplyr)\nlibrary(tidytext)\nlibrary(tidyr)\nlibrary(stringr)\nlibrary(ggplot2)\nlibrary(topicmodels)\nlibrary(purrr)\nlibrary(httr2)\nlibrary(jsonlite)\nlibrary(readr)\nlibrary(kableExtra)\n\n# Load project-specific functions\n# Get more detailed error\ntryCatch(\n  {\n    source(\"R/functions.R\")\n  },\n  error = function(e) {\n    cat(\"Detailed error:\\n\")\n    cat(\"Message:\", e$message, \"\\n\")\n    cat(\"Call:\", deparse(e$call), \"\\n\")\n  }\n)\n\n# Load trained models and corpus metadata\nlda_models <- readRDS(\"output/models/lda_models.rds\")\nk_values <- c(4, 8)\n\n# Set up API Key\nANTHROPIC_API_KEY <- Sys.getenv(\"ANTHROPIC_API_KEY\")\n```\n:::\n\n\n## Prompt Engineering for Interpretation\nWe create a new function `interpret_topic_set_with_llm` that formats the top words from all topics in a model into a single prompt. The prompt instructs the LLM to return a JSON array, with one object for each topic's interpretation.\n\n### Prompt:\n\n>You are an expert political historian specializing in Canadian policy. \n>I have a set of {k_value} topics from a topic model of Canadian Throne Speeches. \n>Your task is to provide a concise interpretation for EACH topic based on its most probable words, considering the context of the other topics.\n>\n>Here is the full set of topics and their words: {topics_words}\n>\n>Please provide your response as a valid JSON array (and ONLY the JSON array, no markdown formatting or extra text). \n>\n>Each element should be an object with these three keys:\n>1. 'topic_id': The integer topic number.\n>2. 'label': A short, descriptive topic label of 3-5 words (e.g., 'National Defense & Foreign Affairs').\n>3. 'focus': A single sentence describing the policy area this topic represents.\n>\n>Return only the JSON array, starting with [ and ending with ]:\n\n\n## Iteratively Interpret Each Topic Set\nNow we'll loop through each model, making a call using `interpret_topic_set_with_llm`, and parse the JSON array result.\n\n**Note**: To reproduce this part you must have an API key with Anthropic. It is not free but $5 credit (the minimum amount) should be enough. Running this loop several times during testing, cost about $0.15. It should not be hard to convert the function to another LLM if cost is an issue.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# This code iterates through each MODEL\nllm_interpretations <- purrr::map2_dfr(\n  lda_models,\n  k_values,\n  function(model, k) {\n    # Get the top 15 terms for all topics in THIS model\n    topics_for_model <- tidy(model, matrix = \"beta\") %>%\n      group_by(topic) %>%\n      slice_max(beta, n = 25) %>%\n      summarise(terms = paste(term, collapse = \", \"), .groups = \"drop\")\n\n    result <- interpret_topic_set_with_llm(\n      k,\n      topics_for_model,\n      ANTHROPIC_API_KEY\n    )\n\n    if (!is.null(result$error)) {\n      log_message(\n        paste(\"API ERROR for k=\", k, \":\", result$error),\n        \"llm_interpretation_log.txt\"\n      )\n      return(tibble(\n        k = k,\n        topic = NA,\n        label = \"API_ERROR\",\n        focus = result$error\n      ))\n    }\n\n    json_text <- result$content[[1]]$text\n\n    log_message(\n      paste(\"Raw response for k=\", k, \":\", substr(json_text, 1, 200), \"...\"),\n      \"llm_interpretation_log.txt\"\n    )\n\n    clean_json <- clean_json_response(json_text)\n\n    parsed_json <- tryCatch(\n      {\n        fromJSON(clean_json, flatten = TRUE)\n      },\n      error = function(e) {\n        log_message(\n          paste(\n            \"JSON parsing error for k=\",\n            k,\n            \":\",\n            e$message,\n            \"\\nCleaned JSON:\",\n            clean_json\n          ),\n          \"llm_interpretation_log.txt\"\n        )\n        return(NULL)\n      }\n    )\n\n    if (is.null(parsed_json)) {\n      return(tibble(\n        k = k,\n        topic = NA,\n        label = \"JSON_PARSE_ERROR\",\n        focus = \"Could not parse JSON response\"\n      ))\n    }\n\n    # Return a tidy data frame, adding the k-value and topic words\n    parsed_json %>%\n      as_tibble() %>%\n      rename(topic = topic_id) %>%\n      mutate(k = k) %>%\n      left_join(topics_for_model, by = \"topic\")\n  }\n)\n\n# Save the resulting interpretations\nsaveRDS(llm_interpretations, \"output/models/llm_topic_labels.rds\")\n```\n:::\n\n\n## Detailed Topic Interpretations \n\n\n### Interpretations for k = 4\n\n<table class=\"table table-striped table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>LLM Interpretations for 4 Topics</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> Topic </th>\n   <th style=\"text-align:left;\"> LLM Label </th>\n   <th style=\"text-align:left;\"> LLM Focus </th>\n   <th style=\"text-align:left;\"> Top 15 Words Sent to LLM </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Parliamentary Procedure &amp; Administration </td>\n   <td style=\"text-align:left;\"> This topic covers the formal parliamentary processes, legislative submissions, and administrative matters including railways, public accounts, and British colonial governance structures. </td>\n   <td style=\"text-align:left;\"> submit, lay, last, railway, subject, public, trade, present, state, unite, session, may, parliament, attention, law, west, estimate, british, past, upon, consideration, measure, relate, account, service </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> Social Policy &amp; Community Welfare </td>\n   <td style=\"text-align:left;\"> This topic encompasses domestic social programs focused on health care, family support, job creation, and community building including Aboriginal affairs. </td>\n   <td style=\"text-align:left;\"> community, health, world, build, support, help, good, economy, family, child, job, care, opportunity, economic, can, create, strong, system, first, investment, action, strengthen, plan, time, aboriginal </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> International Affairs &amp; Defense </td>\n   <td style=\"text-align:left;\"> This topic addresses Canada's international relations, military affairs, trade agreements, and participation in global conferences and diplomatic initiatives. </td>\n   <td style=\"text-align:left;\"> minister, war, house, unite, nation, force, trade, legislation, international, parliament, last, agreement, service, development, provision, consider, amendment, member, common, submit, world, continue, session, conference, measure </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:left;\"> Economic Development &amp; Growth </td>\n   <td style=\"text-align:left;\"> This topic focuses on federal economic policy, including resource development, market growth, provincial-federal cooperation, and programs to stimulate economic development. </td>\n   <td style=\"text-align:left;\"> economic, development, program, federal, opportunity, legislation, improve, social, parliament, economy, world, international, can, minister, service, change, introduce, resource, increase, growth, public, encourage, market, provincial, good </td>\n  </tr>\n</tbody>\n</table>\n\n### Interpretations for k = 8\n\n<table class=\"table table-striped table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>LLM Interpretations for 8 Topics</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> Topic </th>\n   <th style=\"text-align:left;\"> LLM Label </th>\n   <th style=\"text-align:left;\"> LLM Focus </th>\n   <th style=\"text-align:left;\"> Top 15 Words Sent to LLM </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Parliamentary Business &amp; Trade </td>\n   <td style=\"text-align:left;\"> This topic represents formal parliamentary procedures, legislative sessions, and trade relations with emphasis on British Commonwealth connections and railway development. </td>\n   <td style=\"text-align:left;\"> last, submit, may, trade, public, state, session, unite, railway, attention, parliament, conference, present, result, subject, early, british, lay, country, upon, house, time, product, respect, regard </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> Social Programs &amp; Healthcare </td>\n   <td style=\"text-align:left;\"> This topic focuses on healthcare systems, community development, family support, and Aboriginal affairs within the broader context of economic and social investment. </td>\n   <td style=\"text-align:left;\"> health, community, world, child, economy, opportunity, build, help, good, can, support, aboriginal, care, government, life, development, economic, strong, system, investment, need, improve, challenge, family, quality </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> War &amp; International Relations </td>\n   <td style=\"text-align:left;\"> This topic addresses wartime governance, military forces, international agreements, and peacekeeping efforts during periods of global conflict. </td>\n   <td style=\"text-align:left;\"> war, house, force, unite, nation, parliament, minister, provision, common, service, world, submit, member, trade, session, condition, agreement, last, present, peace, upon, may, consideration, necessary, international </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:left;\"> Jobs &amp; Economic Policy </td>\n   <td style=\"text-align:left;\"> This topic centers on employment creation, business support, taxation, and economic security measures to strengthen industry and protect families. </td>\n   <td style=\"text-align:left;\"> job, support, family, good, world, economic, build, community, legislation, help, protect, plan, business, introduce, create, economy, tax, trade, action, security, system, future, industry, time, strengthen </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:left;\"> Infrastructure &amp; Regional Development </td>\n   <td style=\"text-align:left;\"> This topic covers railway expansion, regional development in western and northern Canada, and public infrastructure projects requiring legislative consideration. </td>\n   <td style=\"text-align:left;\"> lay, railway, submit, last, subject, public, west, law, present, trade, relate, parliament, past, measure, unite, north, now, session, consideration, state, several, estimate, upon, service, report </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:left;\"> Federal-Provincial Coordination </td>\n   <td style=\"text-align:left;\"> This topic addresses federal-provincial relations, legislative amendments, international agreements, and coordinated program development across government levels. </td>\n   <td style=\"text-align:left;\"> development, minister, legislation, amendment, nation, unite, international, house, consider, propose, provincial, trade, programme, assistance, approve, federal, continue, measure, place, increase, economic, agreement, last, service, force </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:left;\"> Indigenous Affairs &amp; Climate </td>\n   <td style=\"text-align:left;\"> This topic focuses on Indigenous communities, climate change action, pandemic response, and contemporary social challenges requiring government intervention. </td>\n   <td style=\"text-align:left;\"> community, build, support, help, economy, action, indigenous, good, include, first, change, job, create, health, world, care, pandemic, protect, family, time, safe, home, climate, invest, plan </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> Economic Development Programs </td>\n   <td style=\"text-align:left;\"> This topic encompasses federal economic programs, social development initiatives, resource management, and legislative measures to promote growth and societal improvement. </td>\n   <td style=\"text-align:left;\"> economic, program, development, federal, social, opportunity, parliament, minister, improve, legislation, resource, change, can, society, service, world, economy, international, public, encourage, introduce, increase, one, growth, good </td>\n  </tr>\n</tbody>\n</table>\n\n## Conclusion \nNow that we have interpretations for our topics, we are ready to analyze the models' gamma values—the proportion of each topic within an individual speech. In the final step, we will visualize how these topic proportions change over time, mapping the thematic shifts in Canada's political discourse.\n\n\n**Next Step:** [Topic Shift Analysis & Validation →](07_Topic_Shift_Analysis.qmd)",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}